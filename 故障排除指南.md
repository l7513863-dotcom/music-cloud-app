# 音乐云 - 故障排除指南

## 🚨 常见问题及解决方案

### 1. 服务器启动问题

#### 问题：端口被占用
```
Error: listen EADDRINUSE: address already in use :::3000
```

**解决方案：**
```bash
# 方法1：使用其他端口
set PORT=3001
npm start

# 方法2：关闭占用端口的进程
netstat -ano | findstr :3000
taskkill /PID [进程ID] /F
```

#### 问题：Node.js版本过低
```
Error: Cannot find module '...'
```

**解决方案：**
```bash
# 检查Node.js版本
node --version

# 需要Node.js 14.0或更高版本
# 下载地址：https://nodejs.org/
```

### 2. 文件上传问题

#### 问题：文件上传失败
```
MulterError: File too large
```

**解决方案：**
- 检查文件大小（限制10MB）
- 确保文件格式正确（MP3/WAV/OGG）
- 检查网络连接

#### 问题：上传后文件无法播放
```
音频加载失败
```

**解决方案：**
- 检查音频文件是否损坏
- 确认文件路径正确
- 检查浏览器控制台错误信息

### 3. 数据库问题

#### 问题：数据库连接失败
```
SQLITE_CANTOPEN: unable to open database file
```

**解决方案：**
```bash
# 检查文件权限
dir music.db

# 重新初始化数据库
npm run init-db
```

#### 问题：数据丢失或损坏
```
数据库查询失败
```

**解决方案：**
```bash
# 备份当前数据库
npm run backup

# 重新创建数据库
del music.db
npm run init-db
```

### 4. 前端显示问题

#### 问题：样式显示异常
```
CSS加载失败
```

**解决方案：**
- 检查浏览器缓存（Ctrl+F5强制刷新）
- 确认tailwind.min.css文件存在
- 检查网络连接

#### 问题：JavaScript功能失效
```
Uncaught TypeError: ... is not a function
```

**解决方案：**
- 打开浏览器开发者工具（F12）
- 查看Console标签页的错误信息
- 检查app.js文件是否加载

## 🔧 调试技巧

### 1. 浏览器调试
```javascript
// 在浏览器控制台检查
console.log('调试信息');

// 检查元素是否存在
console.log(document.getElementById('player'));

// 检查网络请求
// 打开Network标签页查看API调用
```

### 2. 服务器端调试
```javascript
// 在server.js中添加调试信息
console.log('请求路径:', req.path);
console.log('请求参数:', req.body);

// 检查文件上传
console.log('上传文件:', req.file);
```

### 3. 数据库调试
```javascript
// 检查数据库查询
db.all('SELECT * FROM songs', [], (err, rows) => {
    if (err) {
        console.error('数据库错误:', err);
        return;
    }
    console.log('歌曲数量:', rows.length);
});
```

## 📊 性能优化建议

### 1. 前端优化
- 使用图片压缩工具减小文件大小
- 启用浏览器缓存
- 优化JavaScript代码加载顺序

### 2. 后端优化
- 添加响应压缩
- 实现请求缓存
- 优化数据库查询

### 3. 网络优化
- 使用CDN加速静态资源
- 启用Gzip压缩
- 优化图片和音频文件

## 🛠️ 维护工具

### 1. 数据库维护脚本
```javascript
// 备份数据库
const fs = require('fs');
fs.copyFileSync('music.db', `backup_${Date.now()}.db`);

// 清理过期文件
// 可以定期清理uploads目录中的旧文件
```

### 2. 日志记录
```javascript
// 添加请求日志
app.use((req, res, next) => {
    console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
    next();
});
```

### 3. 监控脚本
```javascript
// 简单的健康检查脚本
const http = require('http');

function checkServer() {
    http.get('http://localhost:3000/api/health', (res) => {
        console.log(`服务器状态: ${res.statusCode === 200 ? '正常' : '异常'}`);
    }).on('error', (err) => {
        console.error('服务器连接失败:', err.message);
    });
}

// 每5分钟检查一次
setInterval(checkServer, 5 * 60 * 1000);
```

## 🔍 安全建议

### 1. 文件上传安全
- 验证文件类型和大小
- 扫描上传文件的安全性
- 限制上传目录的访问权限

### 2. API安全
- 添加请求频率限制
- 验证输入参数
- 使用HTTPS加密传输

### 3. 数据库安全
- 定期备份重要数据
- 限制数据库访问权限
- 使用参数化查询防止SQL注入

## 📞 获取帮助

### 1. 查看日志文件
```bash
# 查看服务器输出日志
npm start > server.log 2>&1
```

### 2. 社区支持
- 在GitHub提交Issue
- 查看项目文档
- 搜索相关技术论坛

### 3. 联系开发者
- 通过项目GitHub页面联系
- 查看开发者文档
- 参与社区讨论

## 🎯 最佳实践

### 开发阶段
1. **版本控制**：使用Git管理代码版本
2. **代码审查**：定期检查代码质量
3. **测试驱动**：编写测试用例验证功能

### 部署阶段
1. **环境配置**：确保生产环境一致性
2. **备份策略**：定期备份重要数据
3. **监控告警**：设置系统监控和告警

### 维护阶段
1. **定期更新**：保持依赖包最新版本
2. **性能监控**：监控系统性能指标
3. **安全扫描**：定期进行安全漏洞扫描

记住：遇到问题时不要慌张，按照步骤逐一排查，大多数问题都有解决方案！